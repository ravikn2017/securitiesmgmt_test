[phases.setup]
nixPkgs = [
  "nodejs", 
  "python3", 
  "python3Packages.pip",
  "python3Packages.setuptools",
  "python3Packages.wheel", 
  "gcc",
  "glibc",
  "stdenv.cc.cc.lib",
  "zlib",
  "blas",
  "lapack",
  "gfortran",
  "pkg-config"
]

[phases.install]
cmds = [
  "cd backend && npm install",
  "export LD_LIBRARY_PATH=/nix/store/*-gcc-*/lib:/nix/store/*-glibc-*/lib:$LD_LIBRARY_PATH",
  "export BLAS=/nix/store/*-blas*/lib/libblas.so",
  "export LAPACK=/nix/store/*-lapack*/lib/liblapack.so", 
  "pip3 install --break-system-packages --upgrade pip setuptools wheel",
  "pip3 install --break-system-packages -r requirements.txt",
  "ln -sf $(which python3) /usr/local/bin/python || true"
]

[phases.build]
cmds = ["cd backend"]

[start]
cmd = "cd backend && export PATH=/usr/local/bin:$PATH && export PYTHONDONTWRITEBYTECODE=1 && export PYTHONUNBUFFERED=1 && npm run start:prod"